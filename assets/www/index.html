<!DOCTYPE HTML> 
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta http-equiv="Content-type" content="text/html; charset=utf-8">

<title>RunforHealth</title>

    <script type="text/javascript" charset="utf-8" src="cordova-2.5.0.js"></script>
    <script type="text/javascript" src="https://maps.googleapis.com/maps/api/js?sensor=false"></script>
    
    
	
	<link href="bootstrap.css" rel="stylesheet">
	<script src="bootstrap.js"></script>


    <style type="text/css">
	html {height:100%}
	body {height:100%; margin:0; padding:0}
	#map_canvas {height:100%; width:100%}
	</style>
    
    <script type="text/javascript" charset="utf-8">
    
    // ----------------------Time Set--------------------------------------------------
      var ms = 0;
		var state = 0;

		function startstop() {
			if (state == 0) {
			state = 1;
			then = new Date();
			then.setTime(then.getTime() - ms);
			}   
			else {
			state = 0;
			now = new Date();
			ms = now.getTime() - then.getTime();

			hours = Math.floor(ms%(1000 * 60 * 60 * 24)/(1000 * 60 * 60));
			if (hours < 10)
			hours = "0" + hours

			minutes = Math.floor((ms%(1000 * 60 * 60))/(1000 * 60));
			if (minutes < 10)
			minutes = "0" + minutes

			seconds = Math.floor((ms%(1000 * 60))/1000);
			if (seconds < 10)
			seconds = "0" + seconds
    	
			document.all('timer').innerHTML = '<h1>'+hours+':'+minutes+':'+seconds+'</h1>';
   	   		}
		}

		function swreset() {
			state = 0;
			ms = 0;
			document.all('timer').innerHTML = '<h1>00:00:00</h1>';  
			
		}

		function display() {
		setTimeout("display();", 500);
		if (state == 1)  {
		now = new Date();
		ms = now.getTime() - then.getTime();
		hours = Math.floor(ms%(1000 * 60 * 60 * 24)/(1000 * 60 * 60));
		if (hours < 10)
		hours = "0" + hours

		minutes_divisor = ms%(1000 * 60 * 60);
		minutes = Math.floor(minutes_divisor/(1000 * 60));
		if (minutes < 10)
		minutes = "0" + minutes

		seconds_divisor = ms%(1000 * 60);
		seconds = Math.floor(seconds_divisor/1000);
		if (seconds < 10)
		seconds = "0" + seconds

		document.all('timer').innerHTML = '<h1>'+hours+':'+minutes+':'+seconds+'</h1>';
		   
		 
   		}
		}
        </script>

</head>  
  
<body>  
   <div data-role="page" id="page">
	
	<div class="navbar navbar-inverse navbar-static-top">
		<div class="navbar-inner">
			  <a class="brand" href="#" style="float:center"><center><h1>RunforHealth</h1></center></a>
		</div>
	</div><br>
	
	<table border="0" cellspacing="0" cellpadding="0" align="CENTER">
	<tr>
	<td colspan="2" width="351" height="251">
	<div id="map_canvas" align="center"></div>
	</td>
	</tr>

    </table>
    <table border="0" cellspacing="0" cellpadding="0" align="CENTER">
    <form NAME="stpw">
 <tr>
	<td>
    <h4>Time&nbsp;:&nbsp;</h4>
    </td>
    <td>
    	<p id="track_info_info">Travelled 0.00 km</p> <!-- test -->
	<div id="timer" class="logininput" align="center"><h1>00:00:00</h1></div>
    </td>
</tr>
<tr>
	<td colspan="2">
	<div onClick="display()" align="center">
	<button type="button" class="btn btn-small btn-success btn-block" style="width:100%;height:60px;" Name="ssbutton" onClick="startstop()">Start/Stop</button>

	<div onClick="clearMapPolylines()" >
	<button type="button" class="btn btn-large btn-primary btn-block" style="width:100%;height:60px;" NAME="reset" onClick="swreset()">End</button>
	</div>
	</div>
	</form>
    	</td>
</tr>
</table>
</div>
 
    
<script src="http://code.jquery.com/jquery-latest.js"></script>    
<script type="text/javascript">  

        var options = { timeout: 30000 };
        var watchID = navigator.geolocation.watchPosition(initialize, onError, options);

var map; // ��˹������ map ����ҹ�͡�ѧ��ѹ �����������ö���¡��ҹ �ҡ��ǹ�����  
var GGM; // ��˹������ GGM ����� google.maps Object �������¡��ҹ����¢��  
var arr_path=[]; // ��˹����������Ѻ�纤�������� ���˹� path  
var makePolyline; // ��˹������ �ѧ���� ���ҧ��� polylines  
var objPolylines=[]; // ��˹����������Ѻ�纤�� object �ͧ polylines
var arr=[];

function initialize(position) { // �ѧ��ѹ�ʴ�Ἱ���  
    GGM=new Object(google.maps); // �纵���� google.maps Object ���㹵���� GGM  
    // ��˹��ش������鹢ͧἹ���  
    
   var my_Latlng  =  new GGM.LatLng(position.coords.latitude,position.coords.longitude);   //test
    
	arr.push(my_Latlng);
	
    var my_mapTypeId=GGM.MapTypeId.ROADMAP; // ��˹��ٻẺἹ������ʴ�  
    // ��˹� DOM object �������Ἱ�����ʴ� ������� div id=map_canvas  
    var my_DivObj=$("#map_canvas")[0];   
    // ��˹� Option �ͧἹ���  
    var myOptions = {  
        zoom: 16, // ��˹���Ҵ��� zoom  
        center: my_Latlng , // ��˹��ش��觡�ҧ  
        mapTypeId:my_mapTypeId // ��˹��ٻẺἹ���  
    };  
    map = new GGM.Map(my_DivObj,myOptions);// ���ҧἹ�������纵�������㹪��� map  
    
      
      // Calculate the total distance travelled  test
	var total_km = 0;

	for(i = 0; i < position.length; i++){
	    
	    if(i == (position.length - 1)){
	        break;
	    }
	    
	    total_km += gps_distance(arr[i],arr[i+1]);
	}

	 
	var total_km_rounded = total_km.toFixed(2);

	// Display total distance and timetest  test
   $("#track_info_info").html('Travelled <strong>' + total_km_rounded + '</strong> km' ); 

    var my_Marker = new GGM.Marker({ // ���ҧ��� marker  
        position: my_Latlng,  // ��˹���������ǡѺ�ش��觡�ҧ  
        map: map, // ��˹���� marker �����ѺἹ������ instance ��� map  
        draggable:false, // ��˹��������ö�ҡ��� marker �����  
        title:"��ԡ�ҡ�����ҵ��˹觨ش����ͧ���!" // �ʴ� title ��������������������˹��  
    });  
    
      
    // ��˹� event ���Ѻ��� marker ���������ش����ҡ��� marker ���ӧҹ����  
    GGM.event.addListener(map, "bounds_changed", function() {  
        var my_Point = my_Marker.getPosition(my_Latlng);  // �ҵ��˹觢ͧ��� marker ����͡��ҡ���ǻ����  
        arr_path.push(my_Point); // ������ҵ��˹� �ҡ��� marker ���˹�����ش  
        map.panTo(my_Point);  // ���Ἱ����ʴ�价���� marker ����ش  
                  
        makePolyline(arr_path); // �觤�ҵ��˹�� array ����ҧ��� polylines �Ἱ���  
//      console.log(arr_path);  
    });       
  
    // ��˹� event ���Ѻ���Ἱ��� ������ա������¹�ŧ��� zoom  
    GGM.event.addListener(map, "zoom_changed", function() {  
        $("#zoom_value").val(map.getZoom()); // ��Ң�Ҵ zoom �ͧἹ����ʴ�� textbox id=zoom_value    
    });  
}  
  
function onError(error) {
        alert('code: '    + error.code    + '\n' +
              'message: ' + error.message + '\n');
    }
    
    
    //test
	
	var R = 6371; // km
    var toRad = Math.PI / 180;
	
function gps_distance(pos1, pos2){
		var lat1 = pos1.latitude;
        var lon1 = pos1.longitude;
        var lat2 = pos2.latitude;
        var lon2 = pos2.longitude;
		
		var dLat = (lat2 - lat1) * toRad;
        var dLon = (lon2 - lon1) * toRad;
        lat1 = lat1 * toRad;
        lat2 = lat2 * toRad;

        var a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
            Math.sin(dLon / 2) * Math.sin(dLon / 2) * Math.cos(lat1) * Math.cos(lat2);
        var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
        var d = R * c;

        return d;
}
  
  
makePolyline=function(arr_path){  
//  console.log(arr_path.length);  
    var i=arr_path.length-1;  
    objPolylines[i] = new GGM.Polyline({ // ��˹��ٻẺ�ͧ��� polylines  
        path: arr_path,// array ���˹觷���纤�� lat,lon  
        strokeColor: "#FF0000", // ��  
        strokeOpacity: 1.0, // ���������  
        strokeWeight: 2 //����˹�Ңͧ���  
    });   
    objPolylines[i].setMap(map);    // ���ҧ��� polylines �Ἱ���  
//  console.log(arr_path);  
//  console.log(objPolylines);  
}  
clearMapPolylines=function(){  
    arr_path=[];      
    for(i=0;i<objPolylines.length;i++){  
//      console.log(i);  
        objPolylines[i].setMap(null);  
    }  
  
//  console.log(arr_path);  
}  
$(function(){  
    // ��Ŵ ʤ�Ի google map api ����������Ŵ���º��������  
    // ��ҵ���� ���������� google map api  
    // v=3.2&sensor=false&language=th&callback=initialize  
    //  v �����ѹ� 3.2  
    //  sensor ��˹��������ö�ʴ����˹觷��ԴἹ��������� ���������Ѻ��Ͷ�� ������ false  
    //  language ���� th ,en �繵�  
    //  callback ������¡��ѧ��ѹ�ʴ� Ἱ��� initialize  
    $("<script/>", {  
      "type": "text/javascript",  
      src: "http://maps.google.com/maps/api/js?v=3.2&sensor=false&language=th&callback=initialize"  
    }).appendTo("body");      
});  
</script>    
</body>  
</html>  
